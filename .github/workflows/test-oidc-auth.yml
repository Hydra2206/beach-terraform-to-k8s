name: Test OIDC Role Assumption

on:
  workflow_dispatch: {}    # allows manual run from Actions UI

permissions:
  id-token: write      # REQUIRED to allow OIDC token exchange
  contents: read

jobs:
  test-terraform-role:
    name: Test Terraform Role
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (assume terraform role)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_TERRAFORM }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Who am I? (terraform role)
        run: |
          echo "----- sts get-caller-identity -----"
          aws sts get-caller-identity --output json
          echo "----- list S3 buckets (permission test) -----"
          aws s3 ls || true

  test-deploy-role:
    name: Test Deploy Role (ECR)
    runs-on: ubuntu-latest
    needs: test-terraform-role
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (assume deploy role)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_DEPLOY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Who am I? (deploy role)
        run: aws sts get-caller-identity --output json

      - name: Try ECR authorization token (deploy role)
        run: |
          echo "Requesting ECR auth token (ecr:GetAuthorizationToken)"
          aws ecr get-authorization-token --output json || true
